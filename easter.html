<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Easter egg</title>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>

        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
        <script src="utils/earcut.min.js"></script>
    </head>

   <body>

    <canvas id="renderCanvas" touch-action="none"></canvas> <!-- touch-action="none" for best results from PEP -->

    <script>
        const canvas = document.getElementById("renderCanvas"); // Get the canvas element
        const engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
        // better have some global variables to have them always available
        var car

        var groundMat, streetMat, bleachersMat;

        const createScene = () => {
            
            const scene = new BABYLON.Scene(engine);
            const camera = new BABYLON.FollowCamera("camera", new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControl(canvas, true);
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0));

            // building the ground as the base of our environment
            groundMat = new BABYLON.StandardMaterial("groundMat");
            groundMat.diffuseTexture = new BABYLON.Texture("textures/t_kusa_070712c.png");
            
            const ground = BABYLON.MeshBuilder.CreateDisc("ground", {radius: 650}, scene);
            ground.rotation.x = Math.PI / 2;
            ground.position.x = 325;
            ground.position.y = 0.49;
            ground.position.z = -60;
            ground.material = groundMat;

            // building the environment around the street
            BABYLON.SceneLoader.ImportMeshAsync("", "models/banana_peel_mario_kart/", "scene.gltf", scene).then((result) => {
                easter = result.meshes[0];
                easter.scaling = new BABYLON.Vector3(0.2, 0.2, 0.2);
                easter.position.y = 38;
                easter.position.z = -60;
                easter.position.x = 325;
                easter.rotationQuaternion = null;
                easter.rotation.y = Math.PI/180*200;
            });

            BABYLON.SceneLoader.ImportMeshAsync("", "models/mario_kart/", "scene.gltf", scene).then((result) => {
                car = result.meshes[0];
                car.scaling = new BABYLON.Vector3(2, 2, -2);
                car.position.x = 325;
                car.position.z = -500;
                car.position.y = 0.7;
                car.rotationQuaternion = null;
                car.rotation.y = Math.PI;
                // the camera will follow the car with this
                camera.lockedTarget = car;
            });

            // adding sounds
            const soundStart = new BABYLON.Sound("soundStart", "sounds/mk64_racestart.wav", scene, function(){
                soundStart.play();
            });

            // once the start sound is over we proceed with the countdown
            soundStart.onended = function(){

                // countdown for the race to start
                var easterTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                var textBlock = new BABYLON.GUI.TextBlock("text", '');   
                textBlock.color = "orange";
                textBlock.fontSize = 200;
                textBlock.fontFamily = "impact";
                easterTexture.addControl(textBlock);
                textBlock.text = "WELCOME TO THE\n BANANA KINGDOM!";
                var handle = window.setInterval(() => {
                    window.clearInterval(handle);
                    textBlock.dispose();
                    easterTexture.dispose();
                }, 3000);

                setTimeout(function(){

                    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                    let x = new BABYLON.GUI.TextBlock('TextBlock', ''); 
                    x.fontSize = 30;
                    x.fontFamily = "impact";
                    x.color = "black";
                    var rect1 = new BABYLON.GUI.Rectangle();
                    rect1.width = 0.25;
                    rect1.horizontalAlignment = 1;
                    rect1.verticalAlignment = 1;
                    rect1.height = "50px";
                    rect1.width = "900px";
                    rect1.cornerRadius = 10;
                    rect1.color = "white";
                    rect1.thickness = 4;
                    rect1.background = "white";
                    advancedTexture.addControl(rect1);
                    rect1.addControl(x);

                    x.text = 'touch the banana to go back to the main menu';

                }, 5000);

                const countSound = new BABYLON.Sound("countSound", "sounds/mk64_countdown.wav", scene, function(){
                    countSound.play();
                });
                
                countSound.onended = function(){
                    startRace(car);
                }
            };
            return scene;
        };

        function startRace(car) {
            angle = car.rotation.y - Math.PI;

            // let's start the soundtrack of the Luigi's Circuit
            const luigiSound = new BABYLON.Sound("luigiSound", "sounds/mk64_luigicircuit.mp3", scene, null, {
                loop: true,
                autoplay: true 
            });

            // ensures that the user actually follows the track
            scene.registerBeforeRender(function () {

                if (car.position.x > 295 && car.position.x < 355 && car.position.z > -90 && car.position.z < -30){
                    setTimeout(function(){
                        window.location.href = "index.html";
                    }, 200);
                }

                // collision car-endWorld: (car_x-center_x)^2 + (car_z-center_z)^2 > radius^2
                if(Math.pow(car.position.x-325, 2)+ Math.pow(car.position.z+60, 2) > 422500){
                    var endWorldTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                        var textBlock = new BABYLON.GUI.TextBlock("text", '');   
                        textBlock.color = "orange";
                        textBlock.fontSize = 100;
                        textBlock.fontFamily = "impact";
                        endWorldTexture.addControl(textBlock);
                        textBlock.text = "You are not supposed to be here..\n Back in Banana Kingdom!";
                        var handle = window.setInterval(() => {
                            window.clearInterval(handle);
                            textBlock.dispose();
                            endWorldTexture.dispose();
                        }, 3000);
                    car.position.x = -5;
                    car.position.z = 0;
                    car.rotation.y = Math.PI;
                }

                // car's movement update
                car.position.z += 0.4 * Math.cos(angle);
                car.position.x += 0.4 * Math.sin(angle);

                angle = car.rotation.y - Math.PI;


            });

            // controls
            scene.onKeyboardObservable.add((kbInfo) => {
                switch (kbInfo.type) {
                    case BABYLON.KeyboardEventTypes.KEYDOWN:
                        switch (kbInfo.event.key) {
                            case "a":
                            case "A":
                                car.rotation.y -= Math.PI / 12;
                            break
                            case "d":
                            case "D":
                                car.rotation.y += Math.PI / 12;
                            break
                            case "w":
                            case "W":
                                car.position.z += 1 * Math.cos(angle);
                                car.position.x += 1 * Math.sin(angle);
                            break
                            case "s":
                            case "S":
                                car.position.z -= 0.5 * Math.cos(angle);
                                car.position.x -= 0.5 * Math.sin(angle);

                            break
                            case "e":
                            case "E":
        
                            break
                        }
                    break;
                }
            });
        }

        const scene = createScene(); //Call the createScene function
        
        // Register a render loop to repeatedly render the scene
        engine.runRenderLoop(function () {
            scene.render();
        });

        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>

   </body>

</html>
